---
title: "project1"
author: "Liwei Zhang"
date: "January 31, 2019"
output: html_document
---
```{r}
library(tidytext)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(tidyr)
library(scales)
library(topicmodels)
library(tm)
library(wordcloud)
library(RColorBrewer)
library(data.table)


```

```{r}
#hm_data<-read.csv("/Users/liweizhang/Columbia University/cu_semester2/Applied Data Science/project1/project/processed_moments2.csv")

hm_data<-read.csv("C:/Users/lz2655/Downloads/processed_moments_new.csv")
#create age groups
hm_data<-hm_data[!is.na(hm_data$age),]
hm_data$revised_age<-as.numeric(hm_data$age)
hm_data$revised_age<-ifelse(hm_data$revised_age=="prefer not to say",mean(hm_data$revised_age),hm_data$revised_age)

age_breaks<-c(0,20,30,40,50,150)
age_labels<-c("<20","20-30","30-40","40-50",">50")
setDT(hm_data)[ , agegroups := cut(revised_age, 
                                breaks = age_breaks, 
                                right = FALSE, 
                                labels = age_labels)]

```

```{r}
num_female<-nrow(subset(hm_data,gender=="f"))
num_male<-nrow(subset(hm_data,gender=="m"))

num_married<-nrow(subset(hm_data,marital=="married"))
num_single<-nrow(subset(hm_data,marital=="single"))
```


```{r tokenize the sentences}
order_wid<-order(hm_data$wid)#order hm_data by wid
hm_data<-hm_data[order_wid,]

df<-data_frame(wid=hm_data$wid,gender=hm_data$gender,marital=hm_data$marital,text=as.character(hm_data$text))
df<-df %>%
 unnest_tokens(word,text)

```

```{r show most common words}
sentiments_nrc<-get_sentiments("nrc")

df_nrc<-df %>% 
  inner_join(sentiments_nrc) %>%
  count(word, sort = TRUE)

data_tmp <-data.frame(df_nrc[1:10,])
data_tmp$word<-as.vector(data_tmp$word)
data_tmp$word<-factor(data_tmp$word,data_tmp$word)
ggplot(data_tmp)+
  geom_bar(stat="identity",aes(x=word,y=n,col="#F8766D"),fill="#F8766D")+
 # coord_flip()+
  labs(title = "Top 10 frequent sentiment words",y="Number",x="Words")+
  theme(legend.position = 'none')

#library(scales)
# show_col(hue_pal()(4))
# hue_pal()(4)
#[1] "#F8766D" "#7CAE00" "#00BFC4" "#C77CFF"
```

```{r get joy with nrc}
nrc_joy<-get_sentiments("nrc") %>%
  filter(sentiment=="joy")
df_joy<-df %>% 
  inner_join(nrc_joy) 
df_joy

#get "joy" sentiment percent within males, females, married people and single ones
p_joy_male<-nrow(df_joy[df_joy$gender=="m",])/num_male
p_joy_female<-nrow(df_joy[df_joy$gender=="f",])/num_female

p_joy_married<-nrow(df_joy[df_joy$marital=="married",])/num_married
p_joy_single<-nrow(df_joy[df_joy$marital=="single",])/num_single
```

```{r get trust with nrc}
nrc_trust<-get_sentiments("nrc") %>%
  filter(sentiment=="trust")
df_trust<-df %>% 
  inner_join(nrc_trust)
df_trust

#get "trust" sentiment percent within males, females, married people and single ones
p_trust_male<-nrow(df_trust[df_trust$gender=="m",])/num_male
p_trust_female<-nrow(df_trust[df_trust$gender=="f",])/num_female

p_trust_married<-nrow(df_trust[df_trust$marital=="married",])/num_married
p_trust_single<-nrow(df_trust[df_trust$marital=="single",])/num_single
```
```{r get surprise with nrc}
nrc_surprise<-get_sentiments("nrc") %>%
  filter(sentiment=="surprise")
df_surprise<-df %>% 
  inner_join(nrc_surprise)
df_surprise

#get "surprise" sentiment percent within males, females, married people and single ones
p_surprise_male<-nrow(df_surprise[df_surprise$gender=="m",])/num_male
p_surprise_female<-nrow(df_surprise[df_surprise$gender=="f",])/num_female

p_surprise_married<-nrow(df_surprise[df_surprise$marital=="married",])/num_married
p_surprise_single<-nrow(df_surprise[df_surprise$marital=="single",])/num_single
```

```{r compare the three sentiment within male and female}
x_gender<-c("joy","trust","surprise","joy","trust","surprise","f","f","f","m","m","m",p_joy_female,p_trust_female,p_surprise_female,p_joy_male,p_trust_male,p_surprise_male)

gender_sentiments<-data.frame(matrix(x_gender,nrow = 6,ncol = 3))
colnames(gender_sentiments)<-c("sentiments","gender","percentage")#create new dataframs to plot

ggplot(gender_sentiments,aes(sentiments,percentage,fill=gender))+
  geom_bar(stat="identity",position="dodge")
```


```{r compare the three sentiment within married people and single ones}
x_marital<-c("joy","trust","surprise","joy","trust","surprise","married","married","married","single","single","single",p_joy_married,p_trust_married,p_surprise_married,p_joy_single,p_trust_single,p_surprise_single)

marital_sentiments<-data.frame(matrix(x_marital,nrow = 6,ncol = 3))
colnames(marital_sentiments)<-c("sentiments","marital","percentage")#create new dataframs to plot

ggplot(marital_sentiments,aes(sentiments,percentage,fill=marital))+
  geom_bar(stat="identity",position="dodge")
```
#Comments:
#For both plots above, we scale the num of sentiments by the num of sentences for each group(a.k.a.,female and male, married and single)

# Compared to male group, female group show stronger sentiments by having higher scale percentage of using sentiment words. 

# Compared to single group, married group show stronger sentiments by having higher scale percentage of using sentiment words. 

#For all groups, they enjoyed the moment of joy the most, then that of trust and then that of surprise.


#tf-idf
```{r get the word frequency by gender}
df_word_gender<-df %>% 
  count(gender,word,sort = TRUE)

tmp<-df_word_gender%>%
  group_by(gender)%>%
  summarize(total=sum(n))

df_word_gender<-left_join(df_word_gender,tmp)

freq_by_rank_gender<-df_word_gender%>%
  group_by(gender)%>%
  mutate(rank=row_number(),'term frequency'=n/total)

df_word_gender<-df_word_gender%>%
  bind_tf_idf(word,gender,n)

df_word_gender<-df_word_gender%>%
  select(-total)%>%
  arrange(desc(tf_idf))

df_word_gender
```

```{r}
df_word_gender%>%
  arrange(word=factor(word,levels=rev(unique(word))))%>%
  group_by(gender)%>%
  top_n(15)%>%
  ungroup()%>%
  ggplot(aes(word,tf_idf,fill=gender))+
  geom_col(show.legend = FALSE)+
  labs(title="tf_idf by gender",x=NULL,y="tf_idf")+
  facet_wrap(~gender,ncol=2,scales = "free")+
  coord_flip()
```


```{r get the word frequency by marital situation}
df_word_marital<-df %>% 
  count(marital,word,sort = TRUE)

tmp<-df_word_marital%>%
  group_by(marital)%>%
  summarize(total=sum(n))

df_word_marital<-left_join(df_word_marital,tmp)

freq_by_rank_marital<-df_word_marital%>%
  group_by(marital)%>%
  mutate(rank=row_number(),'term frequency'=n/total)

df_word_marital<-df_word_marital%>%
  bind_tf_idf(word,marital,n)

df_word_marital<-df_word_marital%>%
  select(-total)%>%
  arrange(desc(tf_idf))

df_word_marital
```

```{r}
df_word_marital%>%
  arrange(word=factor(word,levels=rev(unique(word))))%>%
  group_by(marital)%>%
  top_n(15)%>%
  ungroup()%>%
  ggplot(aes(word,tf_idf,fill=marital))+
  geom_col(show.legend = FALSE)+
  labs(title="tf_idf by marital",x=NULL,y="tf_idf")+
  facet_wrap(~marital,ncol=2,scales = "free")+
  coord_flip()
```
```{r}
library(wordcloud)
library(RColorBrewer)
set.seed(0)
wordcloud(words = df_word_gender$word, freq =df_word_gender$tf_idf, min.freq = 1,
          max.words=200, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))

```

#LDA
```{r}
df_new<-data_frame(category=hm_data$predicted_category,text=as.character(hm_data$text))
df_tm<-df_new %>%
 unnest_tokens(word,text)
df_tm


```

```{r LDA by gender}
#manual_stopword<-c("friend","day","time","family")

#df_tm <- df_tm %>% 
#  filter(!(word %in% manual_stopword))
#head(df_tm) 

df_tm<-df_tm %>% 
  count(category,word,sort = TRUE)

df_tm<-df_tm%>%
   cast_dtm(category,word,n)
df_tm



df_lda<-LDA(df_tm,k=15,control = list(seed=0))
```



```{r}
df_topics<-tidy(df_lda,matrix("beta"))
df_topics

top_terms<-df_topics%>%
  group_by(topic)%>%
  top_n(5,beta)%>%
  ungroup()%>%
  arrange(topic,-beta)
top_terms
```








```{r}
df_2<-data_frame(wid=hm_data$wid,gender=hm_data$gender,marital=hm_data$marital,age=hm_data$agegroups,text=as.character(hm_data$text))
df_2<-df_2 %>%
 unnest_tokens(word,text)
df_2


```
```{r}
df_topics<-tidy(df_lda,matrix("beta"))
df_topics

top_terms<-df_topics%>%
  group_by(topic)%>%
  top_n(5,beta)%>%
  ungroup()%>%
  arrange(topic,-beta)
top_terms
```



```{r}
top_terms%>%
  mutate(term=reorder(term,beta))%>%
  ggplot(aes(term,beta,fill=factor(topic)))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~topic, scales="free")+
  coord_flip()
```


```{r}
df_tm<-data.frame(df_2)
gender_marital_age<-paste(as.character(df_tm$gender),as.character(df_tm$marital),as.character(df_tm$age),sep=".")
df_tm <-data.frame(cbind(df_tm,gender_marital_age))
head(df_tm)
```


```{r LDA by gender}
manual_stopword<-c("friend","day","time","family")

df_tm <- df_tm %>% 
  filter(!(word %in% manual_stopword))
head(df_tm) 

df_tm<-df_tm %>% 
  count(gender_marital_age,word,sort = TRUE)

df_tm<-df_tm%>%
   cast_dtm(gender_marital_age,word,n)
df_tm

#df_lda<-LDA(df_tm,k=10,control = list(seed=0))
```


```{r}
df_topics<-tidy(df_lda,matrix("beta"))
df_topics

top_terms<-df_topics%>%
  group_by(topic)%>%
  top_n(5,beta)%>%
  ungroup()%>%
  arrange(topic,-beta)
top_terms
```


```{r}
top_terms%>%
  mutate(term=reorder(term,beta))%>%
  ggplot(aes(term,beta,fill=factor(topic)))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~topic, scales="free")+
  coord_flip()
```
```{r}



```

```{r}
n_topics <-c(2, 4, 10, 20, 50, 100)
ap_lda_compare <- n_topics %>%
  map(LDA, x = df_word_marital, control =list(seed = 1109))

geom_point() +
  y = "Perplexity")

```




```{r}



```




```{r}



```




```{r}



```




```{r}



```



```{r}



```




```{r}



```

































